#!/bin/bash

# Script d'installation MEGA Sync pour Ubuntu 24.04
# Auteur: G√©n√©rateur automatique
# Date: $(date)

set -e  # Arr√™ter le script en cas d'erreur

# Couleurs pour les messages
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Fonction pour afficher des messages color√©s
print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_header() {
    echo -e "${PURPLE}$1${NC}"
}

print_cyan() {
    echo -e "${CYAN}$1${NC}"
}

print_header "
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                        INSTALLATION MEGA SYNC                       ‚ïë
‚ïë                           UBUNTU 24.04                              ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
"

print_cyan "‚òÅÔ∏è  Ce script va installer MEGA Sync pour Ubuntu 24.04:"
print_cyan "   ‚Ä¢ T√©l√©chargement automatique du package officiel"
print_cyan "   ‚Ä¢ Installation des d√©pendances requises"
print_cyan "   ‚Ä¢ Configuration de MEGA Sync"
print_cyan "   ‚Ä¢ Int√©gration avec le syst√®me de fichiers"
echo ""

# Variables
MEGA_URL="https://mega.nz/linux/repo/xUbuntu_24.04/amd64/megasync-xUbuntu_24.04_amd64.deb"
TEMP_DIR="/tmp/mega-install"
DEB_FILE="megasync-xUbuntu_24.04_amd64.deb"

# V√©rifier les permissions et pr√©requis
print_info "V√©rification des pr√©requis..."

# V√©rifier si on est sur Ubuntu/Debian
if ! command -v apt &> /dev/null; then
    print_error "Ce script est con√ßu pour Ubuntu/Debian avec apt"
    exit 1
fi

# V√©rifier la connexion internet
if ! ping -c 1 mega.nz &> /dev/null; then
    print_error "Connexion internet requise pour t√©l√©charger MEGA Sync"
    exit 1
fi

print_success "Pr√©requis valid√©s"

# V√©rifier si MEGA Sync est d√©j√† install√©
if command -v megasync &> /dev/null; then
    MEGA_VERSION=$(megasync --version 2>/dev/null || echo "Version inconnue")
    print_warning "MEGA Sync est d√©j√† install√©: $MEGA_VERSION"
    read -p "Voulez-vous le r√©installer/mettre √† jour ? [y/N]: " reinstall
    if [[ ! "$reinstall" =~ ^[Yy]$ ]]; then
        print_info "Installation annul√©e"
        exit 0
    fi
fi

# Mettre √† jour les packages syst√®me
print_info "Mise √† jour des packages syst√®me..."
sudo apt update -y

# Installer les d√©pendances requises pour MEGA Sync
print_info "Installation des d√©pendances MEGA Sync..."
sudo apt install -y \
    wget \
    curl \
    ca-certificates \
    gnupg \
    lsb-release \
    libqt5widgets5 \
    libqt5gui5 \
    libqt5core5a \
    libqt5network5 \
    libqt5svg5 \
    libssl3 \
    libc-ares2 \
    libcrypto++8 \
    libmediainfo0v5 \
    libzen0v5 \
    libuv1

print_success "D√©pendances install√©es"

# Cr√©er le r√©pertoire temporaire
print_info "Cr√©ation du r√©pertoire temporaire..."
mkdir -p "$TEMP_DIR"
cd "$TEMP_DIR"

# T√©l√©charger MEGA Sync
print_info "T√©l√©chargement de MEGA Sync..."
print_info "URL: $MEGA_URL"

if wget -O "$DEB_FILE" "$MEGA_URL"; then
    print_success "T√©l√©chargement r√©ussi"
else
    print_error "√âchec du t√©l√©chargement"

    # URL alternative via repository
    print_info "Tentative avec le repository MEGA..."

    # Ajouter la cl√© GPG MEGA
    wget -qO - https://mega.nz/linux/repo/xUbuntu_24.04/Release.key | sudo apt-key add - || true

    # Ajouter le repository MEGA
    echo "deb https://mega.nz/linux/repo/xUbuntu_24.04/ ./" | sudo tee /etc/apt/sources.list.d/megasync.list

    # Mettre √† jour et installer via repository
    sudo apt update
    if sudo apt install -y megasync; then
        print_success "MEGA Sync install√© via repository"
        cd "$HOME"
        rm -rf "$TEMP_DIR"

        # Aller directement aux v√©rifications finales
        print_info "Installation via repository r√©ussie, passage aux v√©rifications..."
        REPO_INSTALL=true
    else
        print_error "√âchec de toutes les m√©thodes d'installation"
        exit 1
    fi
fi

# Installation du package .deb (si t√©l√©chargement direct r√©ussi)
if [[ "$REPO_INSTALL" != "true" ]]; then
    print_info "Installation du package MEGA Sync..."

    # V√©rifier l'int√©grit√© du fichier t√©l√©charg√©
    if [[ ! -f "$DEB_FILE" ]]; then
        print_error "Fichier $DEB_FILE non trouv√©"
        exit 1
    fi

    # V√©rifier la taille du fichier (doit √™tre > 1MB)
    FILE_SIZE=$(stat -c%s "$DEB_FILE")
    if [[ $FILE_SIZE -lt 1000000 ]]; then
        print_error "Fichier t√©l√©charg√© trop petit ($FILE_SIZE bytes), probablement corrompu"
        exit 1
    fi

    print_success "Fichier v√©rifi√© (${FILE_SIZE} bytes)"

    # Installer le package avec gestion des d√©pendances
    print_info "Installation du package .deb..."
    if sudo apt install -y "./$DEB_FILE"; then
        print_success "MEGA Sync install√© via package .deb"
    else
        print_warning "√âchec de l'installation directe, tentative avec dpkg + fix..."

        # Installer avec dpkg puis corriger les d√©pendances
        sudo dpkg -i "./$DEB_FILE" || true
        sudo apt-get install -f -y

        if command -v megasync &> /dev/null; then
            print_success "MEGA Sync install√© apr√®s correction des d√©pendances"
        else
            print_error "√âchec d√©finitif de l'installation"
            exit 1
        fi
    fi

    # Nettoyer les fichiers temporaires
    print_info "Nettoyage des fichiers temporaires..."
    cd "$HOME"
    rm -rf "$TEMP_DIR"
fi

# V√©rifications finales
print_info "V√©rification de l'installation..."

if command -v megasync &> /dev/null; then
    MEGA_VERSION_FINAL=$(megasync --version 2>/dev/null || echo "Install√©")
    print_success "‚úÖ MEGA Sync install√© avec succ√®s!"
    print_success "Version: $MEGA_VERSION_FINAL"
else
    print_error "‚ùå MEGA Sync n'est pas accessible apr√®s installation"
    exit 1
fi

# V√©rifier l'int√©gration syst√®me
if [[ -f "/usr/share/applications/megasync.desktop" ]]; then
    print_success "Raccourci bureau install√©"
else
    print_warning "Raccourci bureau non trouv√©"
fi

# Configuration additionnelle
print_info "Configuration de MEGA Sync..."

# Cr√©er le r√©pertoire de configuration s'il n'existe pas
mkdir -p "$HOME/.local/share/data/Mega Limited"

# V√©rifier si le service peut d√©marrer
print_info "Test de d√©marrage de MEGA Sync..."
timeout 10 megasync --version &>/dev/null && print_success "MEGA Sync fonctionne correctement" || print_warning "D√©lai d'attente d√©pass√© pour le test"

print_header "
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                    INSTALLATION TERMIN√âE AVEC SUCC√àS                ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
"

print_success "üéâ MEGA Sync install√© avec succ√®s!"
echo ""

print_cyan "üìç Informations d'installation:"
print_info "  üìÅ Ex√©cutable: $(which megasync 2>/dev/null || echo '/usr/bin/megasync')"
print_info "  üñ•Ô∏è  Raccourci: Recherchez 'MEGA' dans le menu des applications"
print_info "  ‚öôÔ∏è  Configuration: ~/.local/share/data/Mega Limited/"
print_info "  üìÑ Logs: ~/.local/share/data/Mega Limited/MEGAsync/logs/"
echo ""

print_cyan "üîß Comment utiliser MEGA Sync:"
print_info "1. Recherchez 'MEGA' dans le menu des applications GNOME"
print_info "2. Ou lancez depuis le terminal: megasync"
print_info "3. Connectez-vous avec votre compte MEGA"
print_info "4. Configurez les dossiers √† synchroniser"
echo ""

print_cyan "‚öôÔ∏è  Fonctionnalit√©s MEGA Sync:"
print_info "‚Ä¢ Synchronisation automatique de fichiers"
print_info "‚Ä¢ Chiffrement de bout en bout"
print_info "‚Ä¢ Partage de fichiers et dossiers"
print_info "‚Ä¢ Versions de fichiers et corbeille"
print_info "‚Ä¢ Int√©gration avec l'explorateur de fichiers"
echo ""

# Proposer de lancer MEGA Sync
read -p "‚òÅÔ∏è  Voulez-vous lancer MEGA Sync maintenant ? [Y/n]: " launch_now
if [[ "$launch_now" =~ ^[Nn]$ ]]; then
    print_info "Vous pouvez lancer MEGA Sync plus tard depuis le menu des applications"
else
    print_info "Lancement de MEGA Sync..."

    # Lancer en arri√®re-plan
    nohup megasync > /dev/null 2>&1 &

    sleep 3

    if pgrep -f megasync > /dev/null; then
        print_success "‚úÖ MEGA Sync lanc√© avec succ√®s!"
        print_info "L'ic√¥ne devrait appara√Ætre dans votre barre de notification"
        print_info "Cliquez dessus pour vous connecter √† votre compte MEGA"
    else
        print_warning "‚ö†Ô∏è  MEGA Sync ne semble pas s'√™tre lanc√© automatiquement"
        print_info "Vous pouvez le lancer manuellement depuis le menu des applications"
    fi
fi

print_cyan "üí° Conseils d'utilisation:"
print_info "‚Ä¢ Premier lancement: connectez-vous avec votre compte MEGA"
print_info "‚Ä¢ Configurez la synchronisation s√©lective pour √©conomiser l'espace"
print_info "‚Ä¢ Utilisez le clic droit dans l'explorateur pour partager des fichiers"
print_info "‚Ä¢ V√©rifiez les param√®tres de bande passante si n√©cessaire"
print_info "‚Ä¢ Les fichiers synchronis√©s apparaissent dans ~/MEGA par d√©faut"

print_cyan "üîí S√©curit√©:"
print_info "‚Ä¢ Vos fichiers sont chiffr√©s de bout en bout"
print_info "‚Ä¢ M√™me MEGA ne peut pas acc√©der √† vos donn√©es"
print_info "‚Ä¢ Gardez votre cl√© de r√©cup√©ration en lieu s√ªr"

print_success "üéØ MEGA Sync est pr√™t √† synchroniser vos fichiers! ‚òÅÔ∏è‚ú®"

# Afficher des informations sur la d√©sinstallation
print_cyan "üóëÔ∏è  Pour d√©sinstaller plus tard:"
print_info "sudo apt remove megasync"
